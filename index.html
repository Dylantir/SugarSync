<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Tienda de Golosinas</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      background-color: #fff5f5;
      margin: 0;
      padding: 0;
    }
    header {
      background-color: #b30000;
      color: white;
      padding: 15px;
      text-align: center;
    }
    nav {
      background-color: #e60000;
      overflow: hidden;
    }
    nav a {
      float: left;
      color: white;
      text-align: center;
      padding: 14px 16px;
      text-decoration: none;
      font-weight: bold;
    }
    nav a:hover {
      background-color: #ff4d4d;
    }
    section {
      display: none;
      padding: 20px;
    }
    section.active {
      display: block;
    }
    input, button, select {
      padding: 8px;
      margin: 5px;
      border-radius: 5px;
      border: 1px solid #ccc;
    }
    button {
      background-color: #e60000;
      color: white;
      cursor: pointer;
    }
    button:hover {
      background-color: #b30000;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 15px;
    }
    th, td {
      border: 1px solid #ddd;
      padding: 8px;
      text-align: center;
    }
    th {
      background-color: #ffcccc;
    }
    h2 {
      color: #b30000;
    }
    canvas {
      margin-top: 30px;
      max-height: 300px;
      width: 100%;
    }
  </style>
</head>
<body>

  <header>
    <h1>üç¨ Tienda de Golosinas üç≠</h1>
  </header>

  <nav>
    <a href="#" onclick="mostrarSeccion('inicio')">Inicio</a>
    <a href="#" onclick="mostrarSeccion('ventas')">Ventas</a>
    <a href="#" onclick="mostrarSeccion('productos')">Productos</a>
  </nav>

  <section id="inicio" class="active">
    <h2>Registrar Venta</h2>
    <label>Fecha: <input type="date" id="fecha" onchange="cambiarFecha()"></label><br>
    <input type="text" id="nombreProducto" placeholder="Nombre del producto">
    <input type="number" id="cantidad" placeholder="Cantidad" min="1">
    <button onclick="agregarProducto()">Agregar</button>
    <button onclick="finalizarVenta()">Finalizar Venta</button>

    <div id="mensaje"></div>
    <div id="listaActual"></div>
  </section>

  <section id="ventas">
    <h2>Historial de Ventas</h2>
    <div id="tablaCompras"></div>
    <canvas id="graficoVentas"></canvas>
  </section>

  <section id="productos">
    <h2>Gesti√≥n de Productos</h2>
    <input type="text" id="nuevoNombre" placeholder="Nombre del producto">
    <input type="number" id="nuevoPrecio" placeholder="Precio">
    <button onclick="agregarNuevoProducto()">Agregar Producto</button>

    <div id="tablaProductos"></div>
  </section>

  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script>
    // ====== Variables globales ======
    let productos = JSON.parse(localStorage.getItem('productos')) || {
      "gansito": 2500, "chocorramo": 3000, "galleta festival": 1200, "galleta oreo": 1500,
      "jet": 1000, "bon bon bum": 600, "snickers": 2700, "chicle trident": 800,
      "papas margarita": 2500, "detodito": 3000, "yogurt alpina": 2500
    };
    let historialPorDia = JSON.parse(localStorage.getItem('historialPorDia')) || {};
    let fechaActual = new Date().toISOString().split('T')[0];
    let numeroVenta = 1;
    let ventaActual = [];

    document.getElementById('fecha').value = fechaActual;

    // ====== Funciones de navegaci√≥n ======
    function mostrarSeccion(id) {
      document.querySelectorAll('section').forEach(s => s.classList.remove('active'));
      document.getElementById(id).classList.add('active');
      if (id === 'ventas') mostrarTabla();
      if (id === 'productos') mostrarProductos();
    }

    // ====== Cambio de fecha ======
    function cambiarFecha() {
      fechaActual = document.getElementById('fecha').value;
      numeroVenta = (historialPorDia[fechaActual]?.length || 0) + 1;
      ventaActual = [];
      mostrarListaActual();
      mostrarTabla();
      mostrarGrafico();
    }

    // ====== Agregar producto ======
    function agregarProducto() {
      const nombre = document.getElementById('nombreProducto').value.trim().toLowerCase();
      const cantidad = parseInt(document.getElementById('cantidad').value);
      const mensaje = document.getElementById('mensaje');

      if (!productos[nombre]) {
        mensaje.innerHTML = `<p style="color:red">‚ùå Producto no encontrado.</p>`;
        return;
      }
      if (!cantidad || cantidad <= 0) {
        mensaje.innerHTML = `<p style="color:red">‚ùå Cantidad inv√°lida.</p>`;
        return;
      }

      const precio = productos[nombre];
      const total = precio * cantidad;
      ventaActual.push({ nombre, cantidad, precio, total });

      mensaje.innerHTML = `<p style="color:green">‚úÖ ${cantidad} ${nombre}(s) agregado(s).</p>`;
      document.getElementById('nombreProducto').value = '';
      document.getElementById('cantidad').value = '';
      mostrarListaActual();
    }

    // ====== Mostrar lista de venta actual ======
    function mostrarListaActual() {
      const cont = document.getElementById('listaActual');
      if (ventaActual.length === 0) {
        cont.innerHTML = "<p>No hay productos agregados.</p>";
        return;
      }

      let totalVenta = 0;
      let html = `<table><tr><th>Producto</th><th>Cantidad</th><th>Precio</th><th>Total</th><th>Acci√≥n</th></tr>`;
      ventaActual.forEach((p, i) => {
        totalVenta += p.total;
        html += `<tr>
          <td>${p.nombre}</td>
          <td>${p.cantidad}</td>
          <td>$${p.precio.toLocaleString('es-CO')}</td>
          <td>$${p.total.toLocaleString('es-CO')}</td>
          <td><button onclick="eliminarProductoActual(${i})">‚ùå</button></td>
        </tr>`;
      });
      html += `<tr><th colspan="3">TOTAL</th><th colspan="2">$${totalVenta.toLocaleString('es-CO')}</th></tr></table>`;
      cont.innerHTML = html;
    }

    function eliminarProductoActual(i) {
      ventaActual.splice(i, 1);
      mostrarListaActual();
    }

    // ====== Finalizar venta ======
    function finalizarVenta() {
      if (ventaActual.length === 0) return alert("Agrega productos primero");
      if (!historialPorDia[fechaActual]) historialPorDia[fechaActual] = [];
      historialPorDia[fechaActual].push({ numeroVenta, productos: ventaActual });
      localStorage.setItem('historialPorDia', JSON.stringify(historialPorDia));

      numeroVenta++;
      ventaActual = [];
      document.getElementById('mensaje').innerHTML =
        `<p style="color:blue">üí∞ Venta finalizada. Nueva venta iniciada (#${numeroVenta})</p>`;
      mostrarListaActual();
      mostrarTabla();
      mostrarGrafico();
    }

    // ====== Mostrar tabla de ventas ======
    function mostrarTabla() {
      const tabla = document.getElementById('tablaCompras');
      const dia = historialPorDia[fechaActual] || [];

      if (dia.length === 0) {
        tabla.innerHTML = "<p>No hay ventas registradas en esta fecha.</p>";
        return;
      }

      let html = `<table><tr><th>N¬∞ Venta</th><th>Producto</th><th>Cantidad</th><th>Total</th></tr>`;
      dia.forEach(v => {
        v.productos.forEach(p => {
          html += `<tr>
            <td>#${v.numeroVenta}</td>
            <td>${p.nombre}</td>
            <td>${p.cantidad}</td>
            <td>$${p.total.toLocaleString('es-CO')}</td>
          </tr>`;
        });
      });
      html += "</table>";
      tabla.innerHTML = html;
      mostrarGrafico();
    }

    // ====== Gr√°fico ======
    function mostrarGrafico() {
      const ctx = document.getElementById('graficoVentas');
      Chart.getChart(ctx)?.destroy();
      const dia = historialPorDia[fechaActual] || [];

      const labels = dia.map(v => `Venta ${v.numeroVenta}`);
      const totals = dia.map(v => v.productos.reduce((a,b)=>a+b.total,0));

      new Chart(ctx, {
        type: 'bar',
        data: {
          labels,
          datasets: [{
            label: `Total por venta (${fechaActual})`,
            data: totals,
            backgroundColor: '#ff4d4d'
          }]
        },
        options: {
          scales: { y: { beginAtZero: true } }
        }
      });
    }

    // ====== Gesti√≥n de productos ======
    function mostrarProductos() {
      const cont = document.getElementById('tablaProductos');
      if (Object.keys(productos).length === 0) {
        cont.innerHTML = "<p>No hay productos.</p>";
        return;
      }

      let html = `<table><tr><th>Producto</th><th>Precio</th><th>Acciones</th></tr>`;
      for (const [nombre, precio] of Object.entries(productos)) {
        html += `<tr>
          <td>${nombre}</td>
          <td>$${precio.toLocaleString('es-CO')}</td>
          <td>
            <button onclick="editarProducto('${nombre}')">‚úèÔ∏è Editar</button>
            <button onclick="eliminarProducto('${nombre}')">‚ùå Eliminar</button>
          </td>
        </tr>`;
      }
      html += "</table>";
      cont.innerHTML = html;
    }

    function agregarNuevoProducto() {
      const nombre = document.getElementById('nuevoNombre').value.trim().toLowerCase();
      const precio = parseInt(document.getElementById('nuevoPrecio').value);
      if (!nombre || !precio) return alert("Completa los campos");

      productos[nombre] = precio;
      localStorage.setItem('productos', JSON.stringify(productos));
      document.getElementById('nuevoNombre').value = '';
      document.getElementById('nuevoPrecio').value = '';
      mostrarProductos();
    }

    function editarProducto(nombre) {
      const nuevoPrecio = prompt(`Nuevo precio para ${nombre}:`, productos[nombre]);
      if (nuevoPrecio && !isNaN(nuevoPrecio)) {
        productos[nombre] = parseInt(nuevoPrecio);
        localStorage.setItem('productos', JSON.stringify(productos));
        mostrarProductos();
      }
    }

    function eliminarProducto(nombre) {
      if (confirm(`¬øEliminar el producto ${nombre}?`)) {
        delete productos[nombre];
        localStorage.setItem('productos', JSON.stringify(productos));
        mostrarProductos();
      }
    }
  </script>
</body>
</html>
